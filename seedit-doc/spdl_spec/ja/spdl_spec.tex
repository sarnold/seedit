\documentclass{article}
\title{SPDL説明書 ver 2.1.}
\author{Yuichi Nakamura \thanks{himainu-ynakam@miomio.jp}}
\begin{document}
\maketitle
\tableofcontents
\newpage
これは、SPDL(Simplified Policy Description Language(単純化ポリシ設定言語))
の設定要素の解説書です。



\section{概要}
seeditのポリシーファイル, Simplified Policy(/etc/seedit/policy)は、SPDLという書式で書かれています。
SPDLコンパイラ(seedit-converterコマンド。seedit-loadコマンドの中で呼び出
されます)によって、SPDLは普通のSELinuxのポリシー書式に変換され、設定が反映さ
れます。

\subsection{機能}
SPDLの主な機能は、ラベルの隠蔽（パス名ベースの設定）と、パーミッションの
絞りこみです。
\begin{itemize}
 \item ラベルの隠蔽\\
       通常のSELinuxでは、ラベルをリソースに付与し、ラベルを使って
       設定する必要があります。ラベルの管理、ラベルとリソースの対応付け
       の把握が繁雑でした。一方、
       SPDLでは、ラベルは隠蔽されています。ファイル名やポート
       番号などのリソース名を指定して設定できます。

 \item パーミッションの絞りこみ\\
       SELinuxには、数百のパーミッションが存在していました。一方SPDLでは、
       パーミッションを除去したり、統合することによって、パーミッション
       の数を絞りこんでいます。セキュリティ上の影響が極力少なくなるよう
       配慮し、絞りこんでいます。\\
       「パーミッション除去」とは、そのパーミッションが全ドメインに許可
       されるようにし、実質そのパーミッションに関するアクセス制御が働か
       ないようにすることです。\\
       「パーミッション統合」は、複数のパーミッションを一つのパーミッショ
       ンとして扱うことです。どんなパーミッションが除去され、統合されて
       いるのかは、
       http://seedit.sourceforge.net/doc/permission\_integrate/にありま
       す。
\end{itemize}


\subsection{SPDLの設定要素の概要}
SPDLは、次のような設定を行うことができます。
\begin{itemize}
 \item アプリケーションへのドメイン付与\\
       ドメインを割り当てるには、SELinuxのドメイン遷移を設定する必要があ
       ります。ドメイン遷移の設定には、２種類の要素が用意されています。\\
       {\it domain\_trans}という諸式は普通のドメイン遷移の諸式です。\\
       {\it program}は、簡略版の書式です。

 \item RBAC\\
       RBACをサポートしています。{\it role}, {\it user}文を使うことで設
       定できます。
 \item ファイルアクセス制御\\       
       {\it allow/deny} 文は、通常ファイルへのアクセス制御設定です。デバ
       イスファイル関連としては、 {\it allowdev}文があります。{\it
       allowtmp}は、一時ファイルの保護に使います。
 \item ネットワークアクセス制御\\
       {\it allownet}文で設定できます。
 \item IPC(プロセス間通信)の制御\\
       {\it allowcom}文で、IPCおよびシグナルのアクセス制御設定ができます。
 \item Keyのアクセス制御\\
       {\it allowkey}文は、プロセス毎の鍵領域のアクセス制御に使います。
 \item その他の特権\\
       その他の、重大なOSの操作については、{\it allowpriv}文で設定します。
\end{itemize}

\subsection{デフォルト拒否}
ドメインは、デフォルトでは、全て拒否されます。

\subsection{用語}
\begin{itemize}
\item ドメイン \\
 ドメインは、SELinuxと同じです。ドメインは、プロセスにドメイン遷移で割り
      当てられます。
\item ロール\\
 SPDLのロールは、単純化されています。ユーザシェルに付与されるドメインと
      同じ意味です。SPDLでは、アクセス制御設定をロールに対して行いますが、
      実際は、ユーザシェルのドメインに対して権限が与えられています。例を
      見てみましょう。sysadm\_rロールに対して許可された権限は、ログイン
     後のユーザーシェルのドメインsysadm\_tに許可されます。\\
      SPDLから生成されるSELinuxのポリシでは, {\it role 全てのロール 全て
      のタイプ;}のような設定がされています。

\item 非制限(unconfined)ドメイン\\
      unconfinedドメインとは、全ての権限が許可されたドメインのことをいい
      ます。つまり、このようなドメインが付与されたプロセスは実質SELinux
      のアクセス制御を受けません。{\it allowpriv all;}と設定されたドメイ
      ンはunconfinedドメインとなります。
\end{itemize}                  

\section{SPDLによる設定の構造}
設定は、「セクション」という単位で構成されます。
セクションとは、 $\{$ 　 $\}$で囲まれた領域のことです。

一つのドメイン・ロールに
対して、セクションが一つ存在し、セクションの中で、ドメイン，ロールに対す
る設定がなされます。

\subsection{セクションの構造}

$\{$  (セクションの開始)\\
$domain/role$  (ドメイン、ロールの宣言。一つのドメイン、ロールしか宣言で
きない。) \\
$users$  (ロールの設定の時のみ有効。)\\
$domain\_trans$|$program$ (ドメイン付与の設定)\\
$allow/deny$|$allowxx$  (ファイルやネットワークなどへのアクセスを許可)\\
$\}$  (セクション終わり)\\

\section{他ファイルの設定を流用:include}
{\it include}を使うことで、他ファイルの設定を流用することができます。
書式は以下です。
include {\it filename};
filenameの内容が、そのまま設定されます。デフォルトでは、filenameは、
/etc/seedit/policy/includeからのパスです。seedit-converterの-Iオプション
でパスを帰ることもできます。


\section{ドメイン、ロールの宣言}
\subsection{ドメインの宣言:domain}
\begin{enumerate}
 \item 書式 \\
      domain {\it domain name} ;
 \item 意味\\
       ドメインを宣言します。セクション中の設定は、ここで宣言したドメイ
       ンに対してなされることになります。
 \item 制約\\
　{\it domain name}は、必ず {\it \_t}で終わる名前である必要があります。
       また、一つのセクション中で2つのドメインの宣言はできません。
\end{enumerate}

\subsection{ロールの宣言:role}
\begin{enumerate}
 \item 書式\\
    role {\it  role name } ;
 \item 意味\\
     ロールを宣言します。ロールを使えるユーザは次の{\it user}文で行いま
       す。
 \item 制約\\
       {\it role name}は、{\it \_r}で終わる必要があります。一つのセクショ
       ン中では１度しか記述できません。
\end{enumerate}

\section{RBACの設定:user}
\begin{enumerate}
 \item 書式\\
       user {\it user name};
 \item 意味\\
       ロールを使えるユーザを列挙します。
 \item 例\\
       \{\\
       role user\_r;\\
       user root;\\
       user ynakam;\\
       ....\\
ユーザrootとynakamがuser\_rロールを使えることを意味します。
\item 制約\\
　ロールが宣言されたセクションでしか使えません。

\end{enumerate}

\section{ドメイン遷移}
SELinuxでは、ドメインを付与するためにドメイン遷移を使います。SPDLは、
このドメイン遷移を詳細に設定するdomain\_trans文および単純設定するprogram文
をサポートしています。

\subsection{domain\_trans}
\begin{enumerate}
 \item 書式\\
    domain\_trans {\it parent domain} {\it filename-of-entrypoint};
 \item 意味\\
    {\it parent domain}のドメインで動作しているプロセスが、 {\it
       filename-of-entrypoint}実行ファイルを実行すると、ドメインが割り当
       てられます。 {\it parent domain}および {\it
       filename-of-entrypoint}は、カンマ区切りで列挙可能です。
 \item 例\\
\begin{verbatim}
{
   domain httpd_t;
   domain_trans initrc_t /sbin/httpd;
...
\end{verbatim}
    initrc\_tドメインで動作するプロセスが、/sbin/httpdを実行すると、
       /sbin/httpdには、httpd\_tドメインが割り当てられます。
 \item 高度な設定\\
       Dynamic domain transitionも設定可能です。 以下のように{\it
       filename-of-entrypoint}を省略します。\\

       \{\\
       domain httpd\_t;\\
       domain\_trans  initrc\_t;\\
       
       initrc\_tからhttpd\_tへのdynamic domain transitionが許可されます。

\end{enumerate}

\subsection{単純なドメイン付与:program}\label{sec:program}
\begin{enumerate}
 \item 書式\\
    program {\it path-to-program};
 \item 意味\\
        {\it path-to-program}が、コマンドラインから起動されたり、
       /etc/init.dから起動された時にドメインを割り当てる書式です。\\
       正確に言うと、unconfinedドメインから起動された時、ドメインが割り
       当てられます。\\
       しかし、認証を伴うプログラムからドメインを割り当てる設定は、これ
       ではできません(su,login,sshdなど)。認証を伴うプログラムに使うドメ
       イン一覧は、converter.confの authentication\_domainフィールドで列
       挙されています。\\
 \item 例\\
1)
\begin{verbatim}
{
domain httpd_t;
program /usr/sbin/httpd;
}

コマンドラインまたはシステム起動スクリプトから/usr/sbin/httpdを起動した
		ら、/usr/sbin/httpdにはhttpd\_tドメインが割り当てられま
			す。
\end{verbatim}
 \item 注意\\
       これは、unconfinedドメインが存在するポリシーのために用意された書
       式です。unconfinedドメインが存在しない場合は、意味がなくなります。\\
       また、RBACが有効な場合は、sysadm\_rロールのシェルから起動した場合
       のみ、ドメインが割り当てられます。sysadm\_rはunconfinedドメインだ
       からです。
\end{enumerate}


\section{Access control to normal files:allow/deny}
\subsection{allow}\label{section:allow}
 \begin{enumerate}
  \item Syntax
	\begin{enumerate}
	 \item allow {\it filename} $\mid$ {\it label} [r],[w],[x],[s],[o],[t],[a],[c],[e],[dx];
	\end{enumerate}
  \item Meaning\\
	\begin{enumerate}
	 \item  Allow access to file.
	\end{enumerate}
  \item Specifying filename\\
	\begin{itemize}
	 \item Wildcard\\
	       For {\it filename} {\it directory}/* and {\it directory}** can
	be used.  For example, /var/* means, all files in /var
	directory, and /var directory. /var/** means, all files under
	/var, /var directory and files/dirs in its
	child,child's child... 	directories.
	 \item Home directories\\
	       File name that starts with  \textasciitilde ~ represents
	       home directory(Not including /root).
	       For example, ~/public\_html means,
	       /home/{\it all users}/public\_html.\\
	       But in role configuration, it is different, it means home directories for users that can use role.

	\end{itemize}

  \item Meaning of permissions.
  \begin{itemize}
   \item r(Read)\\
	 Allows to read file
   \item w(Write)\\
	 Allows to write,create,delete file. Note that creation of
	 device is not allowed unless {\it allowpriv devcreate} is described.
   \item x(eXecute)\\
	 Allows to execute file.
   \item s(Search)\\ 
	 Search file tree. i.e. Get contents of directory. For file,means nothing.
  \end{itemize}
  \item Example\\
	\{\\
	domain httpd\_t;\\
	...\\
	allow /var/www/** r,s;\\
	....\\
	httpd\_t is allowed to read all files and directories under
	/var/www and its children.
  \item Detailed configuration support\\
	In addition to a s,r,x,w permissions, new permissions o,t,a,c,e
	can be used. Permission {\it w} is divided into those
	permissions.\\
	\begin{itemize}
	 \item o: Overwrite\\
	       Allows only writing file, not allow create,delete.
	 \item t: seTattr\\
	       Allow modify attribute of file.
	 \item a: Append\\
	       Allow append to file.
	 \item c: Create\\
	       Allow to create file.
	 \item e: Erase\\
	       Allow to delete file  
	\end{itemize}
  \item Domain execute permission\\
	{\it dx} permission means Domain Execute. If domain is defined
	for the program, program is executed in new domain.
	\begin{verbatim}
Example:
        {
          program /usr/sbin/httpd;
          allow /var/www/cgi-bin/test.cgi r,s,dx;
        }
        {
          program /var/www/cgi-bin/test.cgi;
          allow ............
        }
	\end{verbatim}
	In this case, /usr/sbin/httpd have dx permission to
	test.cgi. Domain is defined below. So, test.cgi runs as
	different domain.           
  \item Limitation about home-directories\\
	Deny statement for individual home directory does not work.
	For example,
	\begin{verbatim}
deny /home/ynakam/public_html;
	\end{verbatim}
does not work.

 \end{enumerate}

\subsection{deny}
\begin{enumerate}
 \item Syntax\\
 deny {\it filename};
 \item Meaning\\
This is used to describe constraints for allow and, also used to cancel allow.
 \item Example
\begin{enumerate}
 \item Example 1: Describe constraints\\
   \begin{verbatim}
*In file constraints
deny /etc/shadow;

*In httpd_t.a
{
domain httpd_t;
include constraints;
allow /etc/* r,s; 
}
   \end{verbatim}
By {\it include constraints;} configuration in file constrains is
       included .
So, the above configuration is the same as following.
       \begin{verbatim}
{
domain httpd_t;
include constraints;
deny   /etc/shadow;
allow /etc/* r,s;
}
       \end{verbatim}
This means, httpd\_t have r,s permission to files in /etc. But can not
       access /etc/shadow.
To allow access to /etc/shadow, 
{\it allow /etc/shadow r,s;} should be described explicitly.
Deny is useful to prevent misconfiguration.

 \item Example 2: Cancel allow\\
\begin{verbatim}
{
domain httpd_t;
allow /etc/* r,s;
deny /etc;
\end{verbatim}
{\it allow /etc/* r,s;} is cancelled by deny /etc;

\end{enumerate}
\end{enumerate}

\subsection{Priority of allow, deny when conflict happens}
 \begin{enumerate}
  \item OR operation(When allow conflicts) \\
	When allow rule conflicts, 
	OR operation is applied.\\
	\begin{itemize}
	 \item Example
	       \begin{verbatim}
domain foo_t;
allow /var/** r;
allow /var/** s;
	       \end{verbatim}
foo\_t have r,s permission to under /var.
	       \begin{verbatim}
domain foo_t;
allow /var/run/* r;
allow /var/run/** w;
	       \end{verbatim}
foo\_t have r permission to in /var.
But for sub-directory(/var/run/xxx etc), it has w permission.

  \item Conflict between child and parent
	       \begin{verbatim}
domain foo_t;
allow /var/** r;
allow /var/run/** w;
	       \end{verbatim}

foo\_t have r permission to under /var(including subdir).
For /var/run , it has only w permission.
	\end{itemize}

  \item Cancel previous configuration(When allow/deny conflicts)\\
	When allow and deny conflicts, 
configuration that appears later survives.
       \begin{itemize}
	  \item Example
		\begin{verbatim}
domain foo_t;
allow /foo/* r,s;
deny  /foo/* ;
		\end{verbatim}
		{\it allow /foo/* r,s} is cancelled.
		\begin{verbatim}
domain foo_t;
deny  /foo/* ;
allow /foo/* r,s;
		\end{verbatim}
		{\it deny /foo/* } is cancelled.

		\begin{verbatim}
domain foo_t;
allow  /foo/bar/** r,s;
deny   /foo/** ;
		\end{verbatim}
		{\it allow /foo/bar/** r,s} is cancelled.

	\item Exception\\
		However,		
		\begin{verbatim}
domain foo_t;
deny  /foo/bar/**;
allow /foo/** r,s;
		\end{verbatim}
		{\it deny /foo/bar/**}  is {\it not} cancelled. To
		cancel deny, you have to describe allow for denied
		directory(in this case, {\it allow /foo/bar some\_permission;})
       \end{itemize}
 \end{enumerate}

\subsection{Special files}
Access to following files are special.
\begin{enumerate}
 \item  /dev/tty* /dev/pts /dev/ptmx, /dev/vcs*,/dev/vcsa*\\
	If you write allow for those file, this does nothing.
	Access control to these files must be done by allowdev. 
 \item  /proc, /sysfs, /selinux, /dev/tmpfs\\
	Allow to these files do nothing, because these files are mounted
	on filesystems that do not support xattr. See allowfs. For
	/selinux see allowpriv getsecurity.
\end{enumerate}


\subsection{Notice about links}
\subsubsection{Treatment of symbolic links}
 Configuration to file that contains symbolic link is ignored.\\
       For example, \\
       allow /etc/init.d/httpd r;\\
       is ignored(init.d is symbolic link to rc.d/init.d).
\subsubsection{Treatment of hard links}
  In Linux system, contents of file can be refered by multiple name
       using hard link. Hardlink is rarely used recent distro, but you
       have to note about this if you want to preserve security.\\
       In SPDL, following rule exists about hard link.\\
       {\it If file has multiple hardlink, to access the file, you must
       specify originally existing file name.}\\
       For example, /etc/shadow and /var/chroot/etc/shadow is hardlinked,
       and /etc/shadow exists originally, to access contents of
       /etc/shadow, you have to use file name /etc/shadow. Configuration
       using /var/chroot/etc/shadow will be igonored. 
       If some domain(assume foo\_t ) want to read
       /var/chroot/etc/shadow, you have to configure {\it allow
       /etc/shadow r;}\\
       Next, there is a question, what is criteria of file {\it
       originally} exist? Following is answer.\\
       In following, /etc/shadow and /var/shadow is assumed as
       hardlinked files.
       \begin{enumerate}
	\item If rule is described to one file, the file is treated as
	      original.\\
	      Ex: allow /etc/shadow r; is described in some domain, but
	      rules using filename /var/shadow is not described,
	      /etc/shadow is treated as original.
	\item If rules are described to multiple hardlinked files, the
	      filename that name is the youngest is treated as
	      original\\
	      Ex: allow /etc/shadow r, and allow /var/shadow r; are
	      described in some domains, /var/shadow is treated as
	      original, because /var/shadow > /etc/shadow.
	\item If rules are not described for hardlinked files, the
	      directory names that hardlinks exist are compared. The
	      file whose directory  name is oldest  is original.\\
	      Ex: /etc/shadow, /var/shadow do not appear in any domain.
	      Then /var/shadow is treated as original. Because
	      /var > /etc.
       \end{enumerate}
       If you are not sure which hardlinke is {\it original}, you can
       use all names. It means, you can describe
\begin{verbatim}
allow /etc/shadow r;
allow /var/shadow r;
\end{verbatim}
1 of 2 will be igored, and do no harm.
  
       Above treatment of hardlink is necessary to avoid a kind of {\it back door }
       of path name based configuration. Assume hard link to
       /etc/shadow is created by some trick under /var/www/html, without this
       behavior, apache web server can access contents of /etc/shadow
       via /var/www/html/shadow. To protect this, we must limit way to access
       hard link to 1.\\
       http://securityblog.org/brindle/2006/04/19 is good reference.\\



\section{Access control to devices:allowdev}
\subsection{allowdev(1)}
 Device files must be handled carefully. Because device files are
interface to kernel. When device file is linked to driver that handles
critical information, read/write to such device will lead to leak of
confidential information or break of system. Following allowdev
statements restricts access to device files.
\begin{enumerate}
 \item syntax
      \begin{enumerate}
       \item allowdev -root {\it directory};
      \end{enumerate}
 \item meaning\\
	By default, when {\it allow} statement is described to file,
	access to device files are not allowed. The directory that
	contains devices must be described in advance, by allowdev
	-root.

 \item Example\\
       \begin{verbatim}
	{ 
	domain httpd_t;
	allow /dev/* r,w;
       \end{verbatim}
       In above, httpd\_t can access normal files under /dev, but can
       not access device files.
       \begin{verbatim}
	{ 
	domain httpd_t;
	allowdev -root /dev;
	allow /dev/* r,w;
       \end{verbatim}
       In above, httpd\_t can access both normal files and devices under
       /dev.
       However, in permission {\it w}, creation and remove devices are not granted unless {\it allowpriv devcreate } is described. 
\end{enumerate}

\subsection{allowdev(2)}
tty devices are device files /dev/tty*, pts devices are devices under
/dev/pts. tty devices represents local login terminal, and pts devices
represents terminal in X and ssh terminal. These devices are linked to
terminal when user logs in, or open X/ssh terminal. If you can write
other users terminal device files, you can write message to his
terminal. 
In SELinux environment, tty/pts device files are given label according to
login user's role. 
So tty/pts device files should be treated differently in SPDL.

\begin{enumerate}
 \item syntax
      \begin{enumerate}
       \item allowdev -pts|-tty|-allterm open;
       \item allowdev -pts|-tty|-allterm {\it role} [r],[w];  
       \item allowdev -pts|-tty|-allterm {\it role} admin;
      \end{enumerate}
 \item meaning\\
       -tty means, tty devices. -pts means, pts devices. -allterms means
       both tty and pts devices.
       \begin{enumerate}
	\item This is usually used in role section. Allow role to have
	      its own tty/pts device. At the time of login, by login
	      program, role's tty device file is given type {\it {\it role prefix}}\_tty\_device\_t. 
	\item  Allow to read/write {\it {\it role}}'s tty
	      device. 
	\item Allow to change label of tty device, and rename, unlink.
       \end{enumerate}
       \item Special role\\
       \begin{itemize}
	\item general\\
	      this means tty/pts before labeled(The type is devtty\_t
	      and tty\_device\_t, devpts\_t, ptmx\_t). Usually, access
	      to these are harmless except {\it admin } permission.
	\item all\\
	      All other roles tty/pts
	\item vcs\\
	      This can be used only in allowdev -tty. Means vcs file(/dev/vcs*, /dev/vcsa*), these provide access to screen-shot of tty terminal. 
       \end{itemize}

\end{enumerate}

\section{Access control to files on misc file systems:allowfs}
 SELinux can do fine-grained access control to files on filesystems that
 support extended-attributes, such as ext3, ext2 and xfs. For such files,
 you configure access control using {\it allow} statement. In other
 filesystems, you should configure {\it allowfs} described in this
 section.

\begin{itemize}
 \item Syntax
       \begin{enumerate}
	\item  allowfs {\it name\_of\_filesystem} [s],[r],[x],[w];\\
	       For {\it name\_of\_filesystem} {\it tmpfs sysfs autofs usbfs cdfs romfs
	       ramfs dosfs smbfs nfs proc proc\_kmsg proc\_kcore xattrfs} can be
	       used.
       \end{enumerate}      
 \item Meaning\\
       \begin{enumerate}

	\item Allow access to files in specified system. For example, {\it
	      allowfs proc s,r;} means to grant s,r access to files on proc
	      filesystem(/proc). When you see logs whose types are {\it
	      filesystem\_t }, you may have to use allowfs. This means, if you
	      find log about {\it read access to sysfs\_t is denied}, you may
	      add {\it allowfs sysfs s,r;}.
		
       \end{enumerate}
       

 \item Notice about {\it name\_of\_filesystem}
       \begin{itemize}
	\item proc filesystem\\
	      Access control to proc file system is a little
	      fine-grained. proc\_kmsg means, /proc/kmsg, proc\_kcore
	      means /proc/kcore. proc\_pid\_self means process information of
	      own process in /proc/pid/. proc\_pid\_other means process information for all
	      others. proc means other files on /proc. 
	\item xattrfs\\
	      This means filesystem that supports extended-attribute,
	      but not configured to use SELinux's label. For example, if
	      you format USB memory as ext3 on non-SELinux machine. Next
	      you mount the USB memory in SELinux machine, 
	      the files on it are recognized
	      as xattrfs. You have to use {\it allowfs xattrfs
	      permissions} in such case.
	\item cdfs\\
	      This corresponds to iso9660 and udf filesystem.
	\item dosfs\\
	      This corresponds to fat, vfat, ntfs.
	\item smbfs\\
	      This corresponds to cifs and smbfs.
       \end{itemize}
\end{itemize}

\section{Access control to temporally file:allowtmp}
\subsection{Why allowtmp is necessary?}
{\it allowtmp} is prepared to configure access control to temporally
files.
Before going detail, let's see why such configuration element is necessary.
SELinux identifies files based on inode, not file name. File name based
configuration does not work correctly when inode number changes or inode
does not exist at the time of configuration(typically such files are
temporally files).
Such files exist under  /var/run, /tmp, /var/tmp.
For example, assume following configuration exists.\\
\begin{verbatim}
domain httpd_t
allow /var/run r,s;
allow /var/run/httpd.pid r,w,s;
\end{verbatim}
At first, httpd\_t have r,w,s permission to /var/run/httpd.pid.
However, when httpd is restarted /var/run/httpd.pid is removed and
created again. In this process, inode number is changed. When inode
number changes, it inherits parent directory's permission. i.e:
 httpd\_t have r,s permission to /var/run/httpd.pid(the permission of
 /var/run). So to grant r,w,s permission to /var/run/httpd.pid, r,w,s
 permission should be given to parent directory(/var/run).
However, in this configuration, httpd\_t can r,w,s other daemons pid
files under /var/run. 
\\
In second example, when program creates files randomly under /tmp it is
a problem. Assume program  A(domain is a\_t) and program B(domain is
b\_t) creates files whose names are random under /tmp. In such
case,following configuration will be described.
\begin{verbatim}
{
domain a_t;
allow /tmp r,w;
}
{
domain b_t;
allow /tmp r,w;
}
\end{verbatim}
This means, program A can access program B's temporally files, and
program B can access program A's temporally files. \\
In above example, access control configuration can not be described for
individual files, but for directory what such files belongs.
If you think it is enough, following will not necessary :-).\\

\subsection{What is allowtmp?}
To resolve this problem, SELinux has a feature called file type
transition. {\it allowtmp } is a feature to configure file type
transition.
In file type transition, when domain creates files under some directory,
created file is given a label. The label can be named by policy.
Following is example  usage of {\it allowtmp}.
\begin{verbatim}
domain httpd_t;
allow /var/run r,s;
allowtmp -dir /var/run -name httpd_var_run_t; -(a)
allow httpd_var_run_t r,w,s; -(b)
\end{verbatim}
In (a), when httpd\_t create file under /var/run, it is labeled as {\it
httpd\_var\_run\_t}. And in (b), httpd\_t can r,w,s access to the
created file. To identify file using label name(httpd\_var\_run\_t).

\subsection{Syntax and meaning}
\begin{enumerate}
 \item Syntax
       \begin{enumerate}
	\item allowtmp -dir {\it directory} -name {\it label} {\it
	      permission};
	\item  allowtmp -fs {\it file system name} -name {\it label} {\it
	      permission};
	      {\it permission} is the same as file permission and can be omitted.
       \end{enumerate}
 \item Meaning\\
       \begin{enumerate}
	\item When domain create file under {\it directory} it is
	      labeled as {\it label} and have permission to the created
	      file specified by {\it permission}. {\it permission} can
	      be omitted. When omitted, permission can be given by {\it allow}.
	\item This is used to configure allowtmp under files that do not
	      support extended attribute, currently, this can be used
	      only for tmpfs.
	\item About label
	      \begin{itemize}
	       \item When {\it label} is {\it auto }, label is named
		     automatically based on domain and directory. For example,
		     domain is hoge\_t, and {\it directory} is /var/, label
		     name is hoge\_var\_t.
	       \item When {\it label} is {\it all} or *, it means all
		     files under {\it directory} created using allowtmp.
	      \end{itemize}           
       \end{enumerate}       
 \item Example\\
       \begin{verbatim}
domain httpd_t	;
allowtmp -dir /var/run -name auto r,w,s;
       \end{verbatim}
Files created under /var/run by httpd\_t is labeled as
       httpd\_var\_run\_t and httpd\_t can r,w,s access to such files.

\begin{verbatim}
domain httpd_t
allowtmp -dir /var/run -name auto r,w,s;
domain named_t
allowtmp -dir /var/run -name auto r,w,s;
domain initrc_t;
allowtmp -dir /var/run -name all r,w,s;
\end{verbatim}
Files created under /var/run by httpd\_t is labeled as
       httpd\_var\_run\_t and httpd\_t can r,w,s access to such
       files(named\_t can not access).
Files created under /var/run by named\_t is labeled as
       named\_var\_run\_t and named\_t can r,w,s access to such
       files(httpd\_t can not access)
initrc\_t can r,w,s access to above files because {\it -name all} is
       specified. {\it -name all} is used to administrate files created
       by allowtmp.

\end{enumerate}



\section{Access control to network:allownet}
{\it allownet} statements is prepared to configure network access control.
It can configure access control to  port , netif(Network
Interface), node(IP address) and inheritance of socket.

\subsection{Port usage}
\begin{enumerate}
 \item Syntax\\
 allownet -protocol {\it protocol} -port {\it port number} {\it permission};\\
 {\it protocol}: tcp,udp can be specified, splitted by ,.\\
 {\it port number}: number and {\it -1023} and {\it 1024-} , and * can
       be described, splitted by ,.\\
 {\it permission}: {\it client} or {\it server} splitted by , can be
       described
 \item Meaning\\
       Allow permissions to be TCP/UDP server/client using port. Port number {\it
       -1023} means, all unused ports under 1023. {\it 1024-} means all
       unused ports after 1024. * means all ports. 
 \item Note about udp server\\
       If you describe allownet -protocol udp -port xxx server;
       The domain also behave as client to port number over 1024.
 \item Example
\begin{verbatim}
domain httpd_t;
# httpd_t can be server using port 80 and 443.
allownet -protocol tcp -port 80,443 server;
# httpd_t can use TCP/UDP 3306 service(MySQL) as client.
allownet -protocol tcp,udp 3306 client;
#Socket usage must be allowd to use port
allownet -protocol tcp,udp use;
\end{verbatim}
\end{enumerate}

\subsection{Usage of RAW socket}
Usage of RAW socket must be restricted, because RAW socket can be used
for IP spoofing and eavesdropping.
\begin{enumerate}
 \item Syntax\\
       allownet -protocol raw use;\\
        {\it permission}: {\it client} or {\it server} or * splitted by , can be
       described.
 \item Meaning\\
       The domain is allowed to use RAW socket.
\end{enumerate}

\subsection{Usage of Network Interface(netif) and IP address(node)}
Usage of netif/node is allowed by this. In default policy, it is allowed
to all domains.
\begin{enumerate}
 \item Syntax\\
       \begin{enumerate}
	\item allownet -protocol {\it protocol} -netif {\it name of NIC} {\it
	      permission};\\
	      {\it protocol}: tcp,udp,raw and * can be specified, splitted by ,.\\
	      {\it name of NIC}: NIC name(such as lo,eth0,eth1) splitted by ,.\\
	      {\it permission}: {\it send} or {\it recv} splitted by , can
	      be described.       
	\item allownet -protocol {\it protocol} -node {\it address} {\it
	      permission};\\
	      {\it protocol}: tcp,udp,raw and * can be specified, splitted by ,.\\
	      {\it address}: {\it ipv4address}/{\it netmask} or * splitted by
	      ,. Example: 192.168.0.1/255.255.255.0 . And * means all address.\\
	      {\it permission}: {\it send} or {\it recv} splitted by , can
	      be described. 
       \end{enumerate}
 \item Meaning\\
       \begin{enumerate}
	\item    Allows to send or receive packet to/from NIC. 
	\item  Allows to send or receive packet to/from IP address. 
       \end{enumerate}
 \item Example\\

\begin{verbatim}
{
domain httpd_t;
allownet -protocol tcp  use;
allownet -protocol tcp -port 80 server;
allownet -netif eth0 send,recv;
}
--> httpd_t can use tcp socket and be server using TCP 80 port.
And can send/recv packet to/from eth0.
\end{verbatim}
\end{enumerate}

\subsection{Inherit socket from other domain}\label{sec:socket}
Following syntax allows using socket of other domain. It is rare to configure.
\begin{enumerate}
 \item  Syntax 
	\begin{enumerate}
	 \item allownet -protocol {\it protocol}  -domain {\it domain} use;
	       {\it protocol}, tcp,udp can be specified, splitted by ,.
	\end{enumerate}

 \item Meaning\\
	\begin{enumerate}
	 \item This enables to restrict inheriting socket from other
	       domain. This configures from where the domain can
	       inherit socket. When {\it domain} is {\it self}, the domain can
	       use socket which is created by its own domain. 
	\end{enumerate}
\item Example
\begin{verbatim}
domain foo_t;
# foo_t can inherit UDP socket from bar_t
allownet -protocol udp -domain bar_t; 
\end{verbatim}
\end{enumerate}
\section{Access control of process communication:allowcom}
\subsection{allowcom (IPC)}
\begin{enumerate}
 \item Syntax(1)\\
       allowcom -ipc {\it to domain} [r],[w];
 \item Syntax(2)\\
       allowcom -unix$\mid$-sem$\mid$-msg$\mid$-msgq$\mid$-shm$\mid$-pipe {\it to
       domain} [r],[w];
 \item Meaning\\
       Allow to communicate with {\it  to domain } by specified IPC.\\
       If {\it to domain } is {\it self}, this means IPC within
       domain. If {\it  to domain } is {\it *} the domain can IPC
       to every domain.
       -ipc is allowing all kinds of IPCs, it is simplified
       configuration. If you want to specify specific kind of ipc, you
       can use following.      
       -unix is unix domain socket, -sem is semaphore, -msg is message,
       -msgq is message queue, -shm is shared memory, -pipe is pipe.
\end{enumerate}

\subsection{allowcom(Signal)}
\begin{enumerate}
 \item Syntax\\
       allowcom -sig {\it to domain} [c],[k],[s],[n],[o];
 \item Meaning\\
       Allow to send signal to {\it to domain}. [c] is sigchld, [k] is
       sigkill, [s] is sigstop, [n] is signull, [o] is other signals. signull is not
       supported, this means all domains are allowed to use signull.
\end{enumerate}



\section{Access control other administrative access
  rights:allowpriv}
\begin{itemize}
 \item Syntax \\
       allowpriv {\it string};\\
       {\it string} is name  of privilege. It is described in next section.
 \item Meaning \\
       Allow access rights represented by        {\it string}.
\end{itemize}
Next, 
what can be configured for {\it string} can be categorized into
following.
\begin{itemize}
 \item POSIX capability\\
 \item Related to kernel\\
 \item Related to SELinux operations\\
 \item Others
\end{itemize}


\subsection{allowpriv: POSIX capability}
Strings that begin with {\it cap\_} is POSIX capability. You can see
detailed meaning by man capabilities.

\subsubsection{Capabilities that can not be configured}
Following POSIX capabilities can not be configured, because it can be
configured in different place. \\
\begin{itemize}
 \item CAP\_NET\_BIND\_SERVICE\\
       This restricts usage of wellknown ports, but by allownet, you can
       configure better. So this is omitted.
 \item CAP\_MKNOD\\
       This is allowed in allowpriv devcreate.
 \item CAP\_AUDIT\_WRITE\\
       Operations that is restricted by this is the same as
       allowpriv audit\_write ,so this  is omitted.
 \item CAP\_AUDIT\_CONTROL\\
       Operations that is  restricted by this is the same as allowpriv
       audit\_control, so this is  omitted.
\end{itemize}

\subsubsection{Configurable capabilities}
\begin{itemize}
 \item cap\_sys\_pacct\\
       Configures kernel accounting(see acct(2)).
 \item cap\_sys\_module\\
       Allows to install kernel module.
 \item cap\_net\_admin\\
       Allow capability {\it CAP\_NET\_ADMIN}(Such as 
       administrate NIC, route table). 
 \item cap\_sys\_boot\\
       Allow capability{\it CAP\_SYS\_BOOT}. This means allow the
       usage of reboot system call.
 \item cap\_sys\_rawio\\        
       Allow capability {\it CAP\_SYS\_RAWIO}.This means usage of
       ioperm, iopl system call and access to /dev/mem.
 \item cap\_sys\_chroot\\
       Allow to use chroot.
 \item cap\_sys\_nice\\
       Allow capability {\it CAP\_SYS\_NICE}. This means process scheduling.
 \item cap\_sys\_resource\\
       Allow capability {\it CAP\_SYS\_RESOURCE}. This means usage
       of rlimit etc.
 \item cap\_sys\_time\\
       Allow capability {\it CAP\_SYS\_TIME}. Thie means modify
       system clock.
 \item cap\_sys\_admin\\
       The same as POSIX capability {\it CAP\_SYS\_ADMIN}. This
       permissions overlaps other permissions, so if you allow
       this, not so serious problem. By denying this,
       it can restrict sethostname and some ioctl operations.
 \item cap\_sys\_tty\_config\\
       The same as capability {\it CAP\_TTY\_CONFIG}. Change
       keyboard configuration, and usage of vhangup call. 
 \item cap\_ipc\_lock\\ 
       Allow capability {\it CAP\_IPC\_LOCK}. This means to lock
       memory.
 \item cap\_dac\_override\\ 
 \item cap\_dac\_read\_search \\
 \item cap\_setuid 
 \item cap\_setgid \\
 \item cap\_chown \\
 \item cap\_setpcap\\
 \item  cap\_fowner\\
 \item  cap\_fsetid \\
 \item cap\_linux\_immutable\\
 \item cap\_sys\_ptrace\\
\item cap\_lease\\
\item cap\_ipc\_owner\\
\item cap\_kill\\

\end{itemize}


\subsection{allowpriv: related to kernel}
Configures privileges to communicate and administrate kernel. 
Following strings can be used.
       \begin{enumerate}
	\item netlink\\
	      Allows to communicate with kernel by netlink socket. 
	\item klog\_read\\
	      Allows to read kernel messages by syslog(2) call. Usually
	      it is required to use dmesg command.
	\item klog\_adm\\
	      Allows to change configuration of kernel message output.
	\item audit\_read\\
	      Allows to read status and configuration of kernel audit
           subsystem.
	\item audit\_write\\
	      Allows to send log message to audit subsystem in
	      kernel.
	\item audit\_adm\\
	      Change configuration of kernel audit subsystem.
	\item klog\_adm\\
	      Allows to change configuration of audit in kernel. The
	      same as capability audit\_control,sys\_pacct.
	      
       
       \end{enumerate}

\subsection{allowpriv: related to SELinux operations}
       Allow privileges to administrate SELinux.
       \begin{enumerate}
	\item relabel\\
	      Allow to relabel all files. You must also allow
	      getsecurity and allowpriv search.
	\item part\_relabel\\
	      Allow to relabel files that the domain can write. You must
	      also allow getsecurity. 
	\item setfscreate\\
	      This is necessary only applications that use SELinux API(setfscreatecon).
	\item getsecurity\\
	      Allow to get security policy decisions, by accessing /selinux.
	\item setenforce\\        
	      Allow to toggle enforcing/permissive mode.
	\item load\_policy\\                    
	      Allow to load policy to kernel.
	\item setsecparam\\
	      Change performance parameter of SELinux via /selinux/avc
	\item getsecattr\\
	      Get security information(such as domain, stored in /proc/pid/attr) of other processes.
       \end{enumerate}

\subsection{allowpriv: other privileges}
       Allow other privileges.
       \begin{enumerate}

	\item quotaon\\         
	      Allow to quotaon.
	\item mount\\         
	      Allow to mount device.

	\item unlabel\\
	      Allow full access to unlabeled files(Files labeled as
	      unlabeled\_t).

	\item devcreate\\
	      Allow to create device files in directory that the domain can write.
	      Without this, a process can not create device
	      file on a directory even it is configured writable.
	\item setattr\\
	      Allow to setattr to files that the domain can s
	      access. Without this setattr permission is granted in w permission.	\item search\\
	      Allow s permission to all files.
	\item read\\
	      Allow r permission to all files.
	\item write\\
	      Allow w permission to all files.
	\item all\\
       \end{enumerate}     

\subsection{denypriv}
This can be used to cancel allowpriv configuration.

\section{Access control of kernel key retention service:allowkey}
This feature is included at version  2.1 or  later.\\

After Linux 2.6.18, new feature {\it kernel key retention service)} is
included. By the feature, each process can obtain key. 
For detail of key retention service, please refer to kernel document
Document/keys.txt (You can look at the copy at
http://free-electrons.com/kerneldoc/latest/keys.txt).
allowkey controls access to key.
This feature is effective only for FC5 or later. Cent OS does not have
kernel key subsystem, so allowkey means nothing.\\

\begin{enumerate}
 \item Syntax\\
       allowkey {\it domain} {\it permissions};\\
For permissions, you can use following.\\
v: View. Look attribute of key.\\
r: Read. Read contents of key.\\
W: Write. Write contents of key. \\
s: Search. Search keyrings.\\
l: Link. Permits key  or keyrings to be linked to.\\
t: Set Attribute: Set attribute of key.\\
For detail of permission, see Document/keys.txt.       
 \item Meaning\\
 Allow access to keys retained by {\it  domain}.\\
For example,\\
allowkey login\_t v,r;\\
means, allow view and  read access to keys, obtained by process whose
       domain is login\_t.

\end{enumerate}



\end{document}
